# Smile
> 微笑美学是口腔正畸学、修复学、医学美学等学科共同关注的热点，具有美学特征额微笑应该具有协调的唇齿关系、微笑曲线以及颊廊间隙等软硬组织关系。

## 术语

### Incisal Edge
切缘下唇曲线

### Cervical Edge
颈缘上唇曲线

### 微笑窗
按照下唇曲线来移动

- 图片旋转，是为了让中线，垂直于两瞳孔之间连线的线，与图片保持一致

### 长度
即牙齿高度，以患者实际牙齿的高度，高低偏移30%的值为最值
因为有两个1号，取最高值的算长度初始值

- 长宽比，如果是对称的，就算一个

长度变化，对所有牙齿都有相同的偏移, 保持牙齿轮廓线底部不改变
- 长宽比在范围内，宽度不变，ratio变化
- 长宽比达到极值，ratio不变，宽度变化

### buccal corridor

颊廊，将其定义为人笑时，上颌可见后牙颊侧面与口角之间的间隙，也称为负性间隙

调整456牙号的宽度改变

### distal
远中

### mesio
近中

### 唇侧
labial

### prosthesis
修复体


## 接口

### 2-factor

- 传8个数值,对称时左右相等,不对称时可能不相等
- 未修改时,默认传1;有修改时,就说修改后的值与原始值的比值 modify/origin
- 

## 算法
最初开始对接算法那边时,算法那边给了一些思路,我结合起来,就使用了最简单的数值做计算,这样每个功能都可以很快速的显示对应要的结果.
可是在对每个功能整合在一起时,就出现问题了, 最后杰伟纠正,让全部使用矩阵来计算.

其实我内心是想的很多,可是没有思路,看到的都是问题,坐标牙,光是给点就没有在这些基础上构建自己的体现.

使用矩阵,在默认的图像坐标系上构建一个新的标准坐标系,用来对所有的图像进行计算.
每个入口可调的参数都需要对应的一个矩阵, 最后把每个作用的变换矩阵都应用到对应的牙齿点上面就可以了.

### 曲率调整
y轴方向上的调整,

### 长度调整

### 曲线拟合

使用CatmullRom,但是我使用的时候,目前还需要一个等距版本,是所有线条上的控制点的相距是相等的,因为[three.js的CatmullRomCurve3](https://threejs.org/docs/#api/en/extras/curves/CatmullRomCurve3)中的实现了这个的

### 邻接关系
要保证牙齿的邻接关系,缩放后平移到对应的逻辑上, 以中线(标准坐标系下的Y轴为基准)保存1号牙的极端值点,从2号到6号牙都以前面的牙齿为基准靠拢.
这样每个牙齿增加一个平移关系

每颗牙齿的近中与远中的差作为间隙. 就是邻牙间近中与远中的差。最后的累计就是多个矩阵相乘起来。
保证顺序从中线向两边开始计算，这样累积的偏移量才是对的。

数字计算使用线性计算，即矩阵来表示，是非常方便的一种方法。计算结果的累积就是多个矩阵的相乘，避免繁复的计算逻辑。
从最简单的代数式计算过渡到线性关系的矩阵计算，是思路的更清晰更模块化，分析也可以细化到最小的模块，且每个都可以独立，
这个思路必须掌握，对以后的提升是非常高效的一种和更能适应的开发模式。

使用二次曲线来拟合切缘曲线

## 交互

通过canvas绘制一张适宽或适高的图片

对AI返回的点建立坐标系，以41、31牙号的中间未竖轴，垂直于41、31牙号最低的关键点为横轴建立二维坐标系，这个坐标系是为了方便调整切缘曲线。

### 定位问题

因为绘制了一张背景图后，并绘制AI返回的特定点位置信息作为初始值。现在对canvas进行放大或缩小后，坐标系的变化导致定位很难了！

html5中hook了一个trackTransform，但是小程序中没有对应的接口和对象，就没有实现，而是简单的处理了

小程序找到DOMMatrix和DOMPoint的polyfill代码，还是实现trackTransform，避免缩放后导致的问题

虽然可以通过颜色来定位，但是精准的位置还是存在偏差。

### 放大镜

放大镜的实现就是利用上一帧的数据重新绘制到另一个小的canvas中

## 问题

### 至2024-2-26

1、颜色更新的问题，原因是流程错误，多次叠加了处理的结果，精简了单次更改结果
2、去掉之前处理阴影的流程逻辑，把不必要的流程删除，ai返回的数据直接映射到原图上，
    A、从我的手机上测试流畅度现在比较顺滑，颜色值的变化现在只有在一开始改变时有点突兀
    B、色调、亮度、饱和度的调整范围要更新，与网页应该有差异
3、修复了UI的双向交互问题，滑动过程中有些没有反应，表现出来给人就是卡的问题，（后面ui更新这方面可能需要花时间）


### 至2024-2-22目前的开发问题
我总结了一下开发中要面临的问题：
目前的形式是微信小程序，但自2023年微信小程序更新后，出现了很多问题，特别是渲染与性能问题，还存在Android和iOS不一致的情况，微信开发社区反馈很多，有线上运营的都出现这种问题，导致不能使用。


对我们的影响就是渲染，涉及两点
1、iOS没有渲染出图片，这个可以改用图片来显示，但在颜色更新时会面临更大的挑战和不确定性。
2、颜色更新的问题，这个涉及到小程序内部的机制（为了跨平台与体验一致性，有一套逻辑像素与物理像素的映射，引入的一个尺寸单位rpx（responsive pixel）机制，导致更新颜色值产生了与接口描述不一致的情况，目前反馈的是不一定修复）。
上面微信小程序出现的问题，微信修复进度很难控制，这些修复改善的地方都是性能瓶颈之处，很难及时更新。
微信小程序的跨平台，在选着App时也面临选着：App开发选着的技术路线也有两套
1、一套就是还是以web技术方案，多跨平台，如Flutter等，可能会提供类似web的接口，但这种性能与微信可能出现同样的问题。
2、另一套就是使用原生的技术，技术上限制最少，比如可以使用opencv等库，但因为是native开发，多使用C++开发，除了核心功能使用第三方库以外，需要自己维护和编写很多，工作量很大
考虑独立的App的额外开销还有：
1、iOS的开发需要苹果的账号，分个人、公司、企业。账号的费用是个人与公司-99美元/年，可以上AppStore，企业-299美元/年。需要苹果电脑
2、Android的开发的app，需要维护不同品牌手机的应用商店，比如华为应用商店、小米应用商店。


## 参考

- 口腔固定修复中的美学重建 第1卷
- [临时网页内容](https://www.sohu.com/a/205746991_377312)
- [catmull](https://github.com/actionnick/cat-rom-spline)
- [gl-vec2](https://github.com/stackgl/gl-vec2)
- [ffmpeg.wasm把视频导出的问题](https://ffmpegwasm.netlify.app/)
- [SmileFy is the Smile Design solution](https://smilefy.com/)
- [Smile Creator – exocad’s innovative in-CAD smile design solution for predictable esthetic smile makeovers](https://exocad.com/our-products/exocad-dentalcad/smile-creator/)